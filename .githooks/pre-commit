#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook: print COMMIT_MANIFEST.md and staged files,
# then require explicit confirmation to proceed.

ROOT="$(git rev-parse --show-toplevel)"
MANIFEST="$ROOT/COMMIT_MANIFEST.md"

if [ -z "${SKIP_COMMIT_MANIFEST-}" ]; then
  echo "\n--- Commit Manifest ---\n"
  if [ -f "$MANIFEST" ]; then
    sed -n '1,200p' "$MANIFEST" || true
  else
    echo "(No COMMIT_MANIFEST.md found)"
  fi

  echo "\n--- Staged files ---\n"
  git --no-pager diff --cached --name-only || true

  echo
  read -r -p "Type 'I AGREE' to proceed with commit (or set SKIP_COMMIT_MANIFEST=1 to bypass): " answer
  if [ "$answer" != "I AGREE" ]; then
    echo "Commit aborted by pre-commit hook. Set SKIP_COMMIT_MANIFEST=1 to bypass." >&2
    exit 1
  fi
fi

exit 0
